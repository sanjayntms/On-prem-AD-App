name: Deploy AD Integrated HR App (Full)


on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: windows-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Deploy to Domain Joined Server
      shell: pwsh
      run: |
        $secpasswd = ConvertTo-SecureString "${{ secrets.DEPLOY_PASS }}" -AsPlainText -Force
        $cred = New-Object System.Management.Automation.PSCredential ("${{ secrets.DEPLOY_USER }}", $secpasswd)

        $session = New-PSSession `
          -ComputerName ${{ secrets.SERVER_IP }} `
          -Credential $cred `
          -UseSSL `
          -SessionOption (New-PSSessionOption -SkipCACheck -SkipCNCheck)

        Invoke-Command -Session $session -ScriptBlock {

            Write-Host "=== Installing IIS if missing ==="

            Install-WindowsFeature `
              -Name Web-Server,Web-Windows-Auth `
              -IncludeManagementTools

            Import-Module WebAdministration

            $sitePath = "C:\inetpub\HRApp"

            if (!(Test-Path $sitePath)) {
                New-Item -ItemType Directory -Path $sitePath
            }
        }

        Write-Host "=== Copying HR App Files ==="

        Copy-Item `
          -Path ".\HRApp\*" `
          -Destination "C:\inetpub\HRApp" `
          -Recurse `
          -Force `
          -ToSession $session

        Invoke-Command -Session $session -ScriptBlock {

            Import-Module WebAdministration

            Write-Host "=== Creating IIS Website if missing ==="

            if (!(Test-Path "IIS:\Sites\HRApp")) {
                New-WebSite `
                  -Name "HRApp" `
                  -Port 80 `
                  -PhysicalPath "C:\inetpub\HRApp"
            }

            Write-Host "=== Configuring Authentication ==="

            Set-WebConfigurationProperty `
              -Filter /system.webServer/security/authentication/windowsAuthentication `
              -Name enabled `
              -Value true `
              -PSPath IIS:\ `
              -Location HRApp

            Set-WebConfigurationProperty `
              -Filter /system.webServer/security/authentication/anonymousAuthentication `
              -Name enabled `
              -Value false `
              -PSPath IIS:\ `
              -Location HRApp

            iisreset
        }

        Remove-PSSession $session
